<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REDEMET Monitor | Live Dashboard</title>

    <!-- Design System & Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        glass: 'rgba(255, 255, 255, 0.05)',
                        brand: '#00f2ff',
                        danger: '#ff4d4d'
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #050510;
            background-image:
                radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 1) 0, transparent 50%);
            background-attachment: fixed;
            color: #fff;
            overflow-x: hidden;
        }

        .aurora {
            position: absolute;
            inset: -50%;
            background: linear-gradient(45deg, #ff0055, #000066, #00ffff);
            mix-blend-mode: hard-light;
            opacity: 0.15;
            filter: blur(80px);
            animation: rotate 20s linear infinite;
            z-index: -1;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .glass-panel {
            background: rgba(20, 20, 30, 0.6);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .animate-enter {
            animation: slideIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        input {
            caret-color: #00f2ff;
        }
    </style>
</head>

<body class="antialiased min-h-screen flex flex-col items-center justify-center p-4 relative" x-data="monitorApp()">

    <div class="aurora"></div>

    <main class="w-full max-w-4xl glass-panel rounded-3xl p-8 relative overflow-hidden animate-enter">

        <!-- Header -->
        <header class="flex justify-between items-center mb-10 border-b border-white/10 pb-6">
            <div class="flex items-center gap-4">
                <div class="p-3 bg-brand/10 rounded-xl rounded-tl-none border border-brand/20">
                    <i data-lucide="radar" class="w-8 h-8 text-brand animate-pulse-slow"></i>
                </div>
                <div>
                    <h1
                        class="text-3xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
                        MONITOR AD WRNG
                    </h1>
                    <div class="flex items-center gap-2 text-sm text-gray-400 mt-1">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                        <span>Localidade • <span x-text="icao"></span></span>
                    </div>
                </div>
            </div>

            <div class="flex flex-col items-end gap-2">
                <!-- Mudança 2: Fonte Maior -->
                <div class="text-5xl font-light font-mono tracking-tighter" x-text="currentTime">00:00</div>
                <div
                    class="text-sm font-bold px-3 py-1 rounded bg-white/5 border border-white/10 uppercase tracking-widest text-gray-400">
                    UTC
                </div>
            </div>
        </header>

        <!-- Status & Controls -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <!-- ICAO Selector -->
            <div class="glass-panel rounded-xl p-4 flex items-center justify-between group hover:border-brand/50 transition-colors cursor-pointer relative"
                @click="startEditingIcao()">

                <div class="w-full">
                    <div class="text-xs text-gray-400 uppercase tracking-wider flex justify-between">
                        <span>Localidade (ICAO)</span>
                        <span
                            class="text-[10px] bg-white/10 px-1 rounded opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1">
                            <i data-lucide="edit-3" class="w-3 h-3"></i> MUDAR
                        </span>
                    </div>

                    <div x-show="!editingIcao"
                        class="mt-1 text-2xl font-bold text-white font-mono flex items-center gap-2">
                        <span x-text="icao"></span>
                    </div>

                    <textarea x-ref="icaoInput" x-show="editingIcao" x-model="tempIcao"
                        @keydown.enter.prevent="saveIcao()" @keydown.escape="cancelEditIcao()" @blur="saveIcao()"
                        class="mt-1 bg-transparent border-b-2 border-brand text-2xl font-bold text-white font-mono w-full focus:outline-none uppercase placeholder-gray-600 resize-none overflow-hidden h-9 py-0"
                        placeholder="Ex: SBGR" maxlength="4" style="display: none;"></textarea>
                </div>
                <i data-lucide="map-pin"
                    class="text-gray-600 group-hover:text-brand transition-colors absolute right-4 top-1/2 transform -translate-y-1/2"></i>
            </div>

            <!-- Countdown -->
            <div class="glass-panel rounded-xl p-4 flex items-center justify-between">
                <div>
                    <div class="text-xs text-gray-400 uppercase tracking-wider">Próxima Checagem</div>
                    <div class="text-2xl font-bold font-mono text-brand mt-1" x-text="countdownDisplay">05:00</div>
                </div>
                <div class="relative w-8 h-8">
                    <svg class="transform -rotate-90 w-8 h-8">
                        <circle cx="16" cy="16" r="14" stroke="currentColor" stroke-width="3" fill="transparent"
                            class="text-gray-800" />
                        <circle cx="16" cy="16" r="14" stroke="currentColor" stroke-width="3" fill="transparent"
                            :stroke-dasharray="circumference"
                            :stroke-dashoffset="circumference - (timeLeft / 300) * circumference"
                            class="text-brand transition-all duration-1000 ease-linear" />
                    </svg>
                </div>
            </div>

            <!-- Audio Toggle (Default ON) -->
            <button @click="toggleAudio()"
                class="rounded-xl p-4 flex items-center justify-between transition-all duration-300 border"
                :class="audioEnabled ? 'bg-brand/20 border-brand/50 text-white' : 'bg-white/5 border-white/10 text-gray-400 hover:bg-white/10'">
                <div class="text-left">
                    <div class="text-xs uppercase tracking-wider" x-text="audioEnabled ? 'Áudio Ativo' : 'Áudio Mudo'">
                    </div>
                    <div class="text-sm font-semibold mt-1"
                        x-text="audioEnabled ? 'Monitorando' : 'Clique para ativar'"></div>
                </div>
                <i :data-lucide="audioEnabled ? 'volume-2' : 'volume-x'" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Content -->
        <div class="relative min-h-[200px]">
            <div x-show="loading"
                class="absolute inset-0 flex items-center justify-center bg-black/20 backdrop-blur-sm z-10 rounded-xl transition-opacity">
                <div class="flex flex-col items-center gap-3">
                    <div class="w-10 h-10 border-4 border-brand border-t-transparent rounded-full animate-spin"></div>
                    <div class="text-xs text-brand tracking-widest uppercase">Consultando API...</div>
                </div>
            </div>

            <div x-show="!loading && warnings.length === 0"
                class="glass-panel rounded-2xl p-12 text-center border-dashed border-2 border-white/5 flex flex-col items-center justify-center gap-4 animate-enter">
                <div class="p-4 bg-white/5 rounded-full">
                    <i data-lucide="check-circle-2" class="w-12 h-12 text-green-500"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-300">Nenhum Aviso Vigente</h3>
                <p class="text-gray-500 max-w-sm">O aeródromo de <b class="text-white" x-text="icao"></b> está operando
                    normalmente sem avisos de aeródromo reportados na API REDEMET.</p>
            </div>

            <template x-for="aviso in warnings" :key="aviso.mens">
                <div
                    class="bg-gradient-to-br from-red-900/40 to-black/60 border border-red-500/30 rounded-2xl p-6 relative overflow-hidden group hover:border-red-500/50 transition-all duration-500 animate-enter mb-4">
                    <div
                        class="absolute -top-10 -right-10 w-32 h-32 bg-red-500/20 blur-3xl rounded-full group-hover:bg-red-500/30 transition-all">
                    </div>

                    <div class="flex flex-col md:flex-row gap-6 relative z-10">
                        <div class="flex-shrink-0">
                            <div
                                class="w-16 h-16 bg-red-500/10 rounded-2xl flex items-center justify-center border border-red-500/20 shadow-[0_0_15px_rgba(255,0,0,0.2)]">
                                <i data-lucide="alert-triangle" class="w-8 h-8 text-red-500"></i>
                            </div>
                        </div>
                        <div class="flex-grow space-y-4">
                            <div class="flex justify-between items-start">
                                <h3 class="text-2xl font-bold text-white tracking-wide">ALERTA DE AVISO DE AERÓDROMO
                                </h3>
                                <div
                                    class="px-3 py-1 bg-red-500 rounded text-xs font-bold text-black uppercase animate-pulse">
                                    Vigente</div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 bg-black/20 p-3 rounded-lg border border-white/5">
                                <div>
                                    <div class="text-xs text-gray-500 uppercase">Início (UTC)</div>
                                    <div class="font-mono text-lg text-red-200"
                                        x-text="formatDate(aviso.validade_inicial)"></div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 uppercase">Fim (UTC)</div>
                                    <div class="font-mono text-lg text-red-200"
                                        x-text="formatDate(aviso.validade_final)"></div>
                                </div>
                            </div>
                            <div
                                class="bg-black/40 p-4 rounded-lg border-l-4 border-red-500 font-mono text-sm text-red-100 leading-relaxed">
                                <span x-text="aviso.mens"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <footer class="mt-8 text-center text-xs text-gray-600 border-t border-white/5 pt-4 flex justify-between">
            <span>Desenvolvido com Tecnologia Antigravity</span>
            <span>Dados Oficiais: REDEMET API</span>
        </footer>
    </main>

    <!-- Overlay Alarm -->
    <div x-show="showAlarmOverlay" x-transition
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md p-4"
        style="display: none;">
        <div
            class="max-w-lg w-full bg-[#1a0505] border-2 border-red-600 rounded-3xl p-8 text-center shadow-[0_0_100px_rgba(255,0,0,0.4)] relative overflow-hidden">
            <div class="absolute inset-0 opacity-10"
                style="background: repeating-linear-gradient(45deg, transparent, transparent 10px, #ff0000 10px, #ff0000 20px);">
            </div>
            <div class="relative z-10 flex flex-col items-center gap-6">
                <div class="w-24 h-24 bg-red-600 rounded-full flex items-center justify-center animate-bounce">
                    <i data-lucide="bell-ring" class="w-12 h-12 text-white"></i>
                </div>
                <h2 class="text-4xl font-black text-white uppercase tracking-tighter">Atenção Piloto</h2>
                <p class="text-red-200 text-lg">Novo aviso meteorológico detectado para <b x-text="icao"></b>.
                </p>

                <!-- Aviso de Autoplay Bloqueado -->
                <div x-show="audioBlocked"
                    class="bg-yellow-500/20 border border-yellow-500/50 p-3 rounded-xl animate-pulse">
                    <p class="text-yellow-200 font-bold uppercase text-sm">⚠️ Áudio Bloqueado pelo Navegador</p>
                    <p class="text-yellow-100/70 text-xs mt-1">Clique na tela para habilitar o som</p>
                </div>

                <button @click="stopAlarm()"
                    class="w-full py-4 bg-white text-red-900 font-bold text-xl rounded-xl hover:bg-gray-200 uppercase">
                    Reconhecer e Silenciar
                </button>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('monitorApp', () => ({
                icao: 'SBMQ',
                tempIcao: '',
                editingIcao: false,
                apiKey: 'povFnv4k9aMAGTXnxNVjXfj6cViT0Pqy7RGNUyzM',
                currentTime: '',
                timeLeft: 300,
                circumference: 2 * Math.PI * 14,
                loading: false,
                warnings: [],
                lastMsgHash: '',
                audioEnabled: true, // Mudança 3: Default ON
                showAlarmOverlay: false,
                audioBlocked: false,
                audioCtx: null,

                init() {
                    const saved = localStorage.getItem('adwrng_icao');
                    if (saved) this.icao = saved;

                    // Tenta iniciar o áudio imediatamente não espera clique
                    this.initAudio();

                    this.updateTime();
                    setInterval(() => this.updateTime(), 1000);
                    this.startCountdown();
                    this.fetchData();
                    setTimeout(() => lucide.createIcons(), 100);

                    // Fallback: garante resume no clique caso o autoplay tenha falhado
                    const unlock = () => {
                        if (this.audioCtx && this.audioCtx.state === 'suspended') {
                            this.audioCtx.resume();
                        }
                    };
                    document.addEventListener('click', unlock);
                    document.addEventListener('keydown', unlock);
                },

                startEditingIcao() {
                    if (this.editingIcao) return;
                    this.editingIcao = true;
                    this.tempIcao = this.icao;
                    this.$nextTick(() => this.$refs.icaoInput.focus());
                },

                saveIcao() {
                    if (!this.editingIcao) return;
                    let val = this.tempIcao.toUpperCase().trim().replace(/[^A-Z]/g, '');

                    if (val.length === 4) {
                        if (val !== this.icao) {
                            this.icao = val;
                            localStorage.setItem('adwrng_icao', this.icao);
                            this.warnings = []; // Clear old data visually
                            this.loading = true; // Show loading
                            this.fetchData(); // Fetch new data immediately (Mudança 4)
                        }
                    }
                    this.editingIcao = false;
                },

                cancelEditIcao() { this.editingIcao = false; },

                get countdownDisplay() {
                    const m = Math.floor(this.timeLeft / 60).toString().padStart(2, '0');
                    const s = (this.timeLeft % 60).toString().padStart(2, '0');
                    return `${m}:${s}`;
                },

                updateTime() {
                    const now = new Date();
                    const h = now.getUTCHours().toString().padStart(2, '0');
                    const m = now.getUTCMinutes().toString().padStart(2, '0');
                    this.currentTime = `${h}:${m}`;
                },

                startCountdown() {
                    setInterval(() => {
                        this.timeLeft--;
                        if (this.timeLeft <= 0) {
                            this.fetchData();
                            this.timeLeft = 300;
                        }
                    }, 1000);
                },

                formatDate(dateStr) {
                    if (!dateStr) return '--';
                    // Ajuste para garantir que a data seja interpretada como UTC
                    // A API retorna "YYYY-MM-DD HH:MM:SS" (UTC), mas o new Date() assume Local Time
                    // Ao formatar para ISO 8601 com 'Z' ("YYYY-MM-DDTHH:MM:SSZ"), forçamos UTC.
                    let safeDate = dateStr;
                    if (typeof dateStr === 'string' && !dateStr.includes('Z')) {
                        safeDate = dateStr.replace(' ', 'T') + 'Z';
                    }

                    const d = new Date(safeDate);
                    const day = d.getUTCDate().toString().padStart(2, '0');
                    const mon = (d.getUTCMonth() + 1).toString().padStart(2, '0');
                    const ho = d.getUTCHours().toString().padStart(2, '0');
                    const mi = d.getUTCMinutes().toString().padStart(2, '0');
                    return `${day}/${mon} ${ho}:${mi}`;
                },

                toggleAudio() {
                    this.audioEnabled = !this.audioEnabled;
                    if (this.audioEnabled) {
                        this.initAudio();
                        this.playBeep(0.1, 880);
                    } else {
                        this.stopAlarm();
                    }
                },

                async fetchData() {
                    // Avoid stuck loading
                    const timeout = setTimeout(() => this.loading = false, 10000);

                    this.loading = true;
                    try {
                        const now = new Date();
                        const y = now.getUTCFullYear();
                        const mo = (now.getUTCMonth() + 1).toString().padStart(2, '0');
                        const da = now.getUTCDate().toString().padStart(2, '0');
                        const ho = now.getUTCHours().toString().padStart(2, '0');
                        const timeParam = `${y}${mo}${da}${ho}`;

                        const url = `https://api-redemet.decea.mil.br/mensagens/aviso/${this.icao}?api_key=${this.apiKey}&data_ini=${timeParam}&data_fim=${timeParam}`;

                        const res = await fetch(url);
                        const json = await res.json();

                        if (json.status && json.data.data) {
                            this.warnings = json.data.data;
                            if (this.warnings.length > 0) {
                                const newMsg = this.warnings[0].mens;
                                if (newMsg !== this.lastMsgHash) {
                                    this.lastMsgHash = newMsg;
                                    this.triggerAlarm();
                                }
                            } else {
                                this.lastMsgHash = '';
                            }
                        } else {
                            this.warnings = [];
                        }
                    } catch (e) {
                        console.error(e);
                    } finally {
                        clearTimeout(timeout);
                        this.loading = false;
                        this.$nextTick(() => lucide.createIcons());
                    }
                },

                initAudio() {
                    if (!this.audioCtx) {
                        const AudioContext = window.AudioContext || window.webkitAudioContext;
                        this.audioCtx = new AudioContext();

                        // Monitor state changes
                        this.audioCtx.onstatechange = () => {
                            if (this.audioCtx.state === 'running') {
                                this.audioBlocked = false;
                            }
                        };
                    }

                    // Tenta acordar agressivamente
                    if (this.audioCtx.state === 'suspended') {
                        this.audioCtx.resume().then(() => {
                            this.audioBlocked = false;
                        }).catch(() => {
                            this.audioBlocked = true;
                        });
                    }
                },

                playBeep(duration = 0.2, freq = 880) {
                    this.initAudio();

                    // Se ainda estiver suspenso após a tentativa de init, marca como bloqueado
                    if (this.audioCtx.state === 'suspended') {
                        this.audioBlocked = true;
                        // Tenta de novo sem bloquear o fluxo
                        this.audioCtx.resume().catch(e => console.log("Autoplay blocked:", e));
                    } else {
                        this.audioBlocked = false;
                    }

                    // Cria o som mesmo assim (se desbloquear logo em seguida, toca)
                    try {
                        const osc = this.audioCtx.createOscillator();
                        const gain = this.audioCtx.createGain();

                        osc.type = 'square';
                        osc.frequency.setValueAtTime(freq, this.audioCtx.currentTime);

                        gain.gain.setValueAtTime(0.01, this.audioCtx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.2, this.audioCtx.currentTime + 0.05);
                        gain.gain.exponentialRampToValueAtTime(0.01, this.audioCtx.currentTime + duration);

                        osc.connect(gain);
                        gain.connect(this.audioCtx.destination);

                        osc.start();
                        osc.stop(this.audioCtx.currentTime + duration);
                    } catch (e) {
                        console.error("Audio error:", e);
                    }
                },

                triggerAlarm() {
                    if (!this.audioEnabled) return;

                    this.showAlarmOverlay = true;
                    this.initAudio(); // Tenta ativar audio context

                    const playLoop = () => {
                        if (!this.showAlarmOverlay) return;

                        // Verifica estado do áudio
                        if (this.audioCtx && this.audioCtx.state === 'suspended') {
                            this.audioBlocked = true;
                            this.audioCtx.resume().catch(() => { });
                        }

                        this.playBeep(0.2, 880); // High pitch

                        setTimeout(() => {
                            if (this.showAlarmOverlay) this.playBeep(0.2, 587); // Low pitch
                        }, 300);

                        this.alarmTimeout = setTimeout(playLoop, 800);
                    };
                    playLoop();
                },

                stopAlarm() {
                    this.showAlarmOverlay = false;
                    this.audioBlocked = false; // Reset warning
                    if (this.alarmTimeout) clearTimeout(this.alarmTimeout);
                }
            }))
        })
    </script>
</body>

</html>